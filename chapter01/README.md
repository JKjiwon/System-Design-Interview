# chapter1. 사용자 수에 따른 규모 확장성

`한명의 사용자를 위한 시스템 -> 수백만명 사용자를 위한 시스템`

## 단일 서버

- 웹/모바일 트래픽 처리 서버(웹계층)과 데이터베이스 서버(데이터 계층)을 한대의 서버로 구성

## 데이터베이스

- 웹계층과 데이터 계층을 분리 -> 각 계층을 독립적으로 확장 가능

### 데이터베이스의 종류

- RDBMS
- NOSQL

## 수직적 규모 확장(scale up) vs 수평적 규모 확장(scale out)

### scale up

- 서버를 보다 높은 사양으로 업그레이드(단순함)
- 서버로 유입되는 트래픽의 양이 적을 때 사용
- 한대의 서버에 CPU나 메모리를 무한대 증설 할 수 없다.
- 장애에 대한 자동복구(failover), 다중화(redundancy) 불가능

### scale out

- 비슷한 사양의 서버를 추가로 연결하여 트래픽 부하를 분산 처리
- 여러 노드를 연결해 병렬 컴퓨팅 환경을 구성하고 유지하려면 아키텍처에 대한 높은 이해도가 요구

## 로드밸런스

- 부하 분산 집합에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할
- 클라이언트는 로드밸런스(Public IP)를 통해 웹 서버(Private IP)에 접근
- failover, redundancy

## 데이터 베이스 다중화

- master - slave 구조
- 쓰기 연산(master)과 읽기 연산(slave)을 다른 데이터베이스에서 처리

## 캐시

- 값비싼 연산 결과 또는 자주 참조되는 데이터를 메모리에 저장(휘발성 데이터)
- 데이터베이스의 호출을 줄여 성능 향상

### 캐시 사용의 유의점

- 데이터 갱신은 자주 일어나지 않지만 참조는 빈번하게 일어나는 경우 고려해볼 만한다.
- 캐시는 데이터를 휘발성 메모리에 저장하므로, 영속적으로 보관할 데이터는 캐시에 두지 않는다.
- 만료(expire) 정책 마련
- 데이터의 일관성을 위해 저장소의 원본을 갱신하는 연산과 캐시를 갱신하는 연산을 단일 트랜잭션으로 처리해야 한다.
- SPOF를 피하기위해 여러 지역에 걸쳐 캐시 서버를 분산시켜야 한다.
- 캐시 메모리를 과할당(overprovision)
- 데이터 방출(eviction) 고려 -> LRU, LFU, FIFO

## 콘텐츠 전송 네트워크(CDN)

- 정적 콘텐츠를 전송하는데 쓰이는, 지리적으로 분산된 서버의 네트워크
- 이미지, 비디오, CSS, JavaScript 파일 등을 캐시

### CDN 사용 시 고려해야 할 사항

- 비용: 자주 사용되지 않는 콘텐츠는 캐싱하지 않는다.
- 만료 시한 설정: 캐시 데이터 최신화
- CDN 장애에 대한 대처 방안 마련
- 콘텐츠 무효화(invalidation): 캐시된 콘텐츠를 강제로 삭제하여 새로운 콘텐츠를 가져오는 것
    - 무효화 API
    - object versioning

## 무상태(stateless) 웹 계층

- 상태 정보(ex. 사용자 세션 데이터)를 웹 계층에서 제거
- 상태 정보를 저장하기 위한 웹서버와 물리적을 분리된 공유 저장소 도입

## 데이터 센터

- 지리적 라우팅(geoDNS-routing): 두개 이상의 데이터 센터가 운영되는 경우 장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내됨
- 데이터 센터 중 하나에 심각한 장애가 발생하면 모든 트래픽이 다른 하나에 집중됨

### 다중 데이터 센터의 기술적 난제

- 트래픽 우회 방법
- 데이터 동기화: [넷플릭스의 데이트 센터 다중화](https://netflixtechblog.com/active-active-for-multi-regional-resiliency-c47719f6685b)
- 여러 위치에서의 테스트, 자동화된 배포 도구

## 메세지 큐

- 무손실 비동기 통신을 지원하는 컴포넌트
- 생산자 - 소비자 구조
- 서비스 간의 결합이 느슨해져(loosely coupled), 규모의 확장성(시스템의 규모를 얼마나 유연하게 조절할 수 있는 있는지를 나타냄)이 보장되어야 하는 어플리케이션을 구성하기 좋음

## 로그, 메트릭 그리고 자동화

- 로그: 로그를 단일 서비스로 모아주는 도구 활용
- 메트릭: 사업 현황의 유용한 정보 획득, 시스템의 현재 상태 파악 가능
- 자동화: 빌드, 테스트, 배포 등의 자동화 -> 개발 생산성 향상

## 데이터베이스의 규모 확장

- 수직적 향상: SPOF 위험 발생
- 수평적 확장(샤딩):
    - 모든 샤드는 같은 스키마를 쓰지만 샤드에 보관되는 데이터 사이에는 중복이 없다.
    - 데이터를 고르게 분할 할 수 있도록 하는 샤딩 키를 어떻게 정하느냐가 중요

### 샤딩의 도입시 고려해야 할점

- 데이터 재샤딩: 안정해시
- 유명인사 문제(핫스팟 키 문제)
- 조인의 어려움과 비정규화

## 백만 사용자, 그리고 그 이상

- 웹 계층은 무상태 계층으로
- 모든 계층에 다중화 도입
- 가능한 한 많은 데이터를 캐시할 것
- 여러 데이터 센터를 지원할 것
- 정적 콘텐츠는 CDN을 통해 서비스할 것
- 데이터 계층은 샤딩을 통해 그 규모를 확장할 것
- 각 계층은 독립적 서비스로 분할할 것
- 시스템을 지속적으로 모니터링하고, 자동화 도구들을 활용할 것

## 참조

[가상 면접 사례로 배우는 대규모 시스템 설계 기초](https://www.yes24.com/Product/Goods/102819435)